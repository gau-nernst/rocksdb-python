name: Build wheels
on:
  push:
    paths-ignore:
      - .github/workflows/build_conda.yaml
      - .github/workflows/build_linux.yaml
      - .github/workflows/build_macos_homebrew.yaml
      - .github/workflows/build_windows_vcpkg.yaml
      - README.md
      - .gitignore

jobs:
  macos_x64:
    runs-on: macos-11
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install RocksDB from Homebrew
        run: brew install rocksdb
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.12.1
        env:
          MACOSX_DEPLOYMENT_TARGET: "11.0"

          CIBW_BUILD_VERBOSITY: 1
          CIBW_BUILD: cp{37,38,39,310,311}-macosx_x86_64

          CIBW_TEST_REQUIRES: pytest
          CIBW_TEST_COMMAND: pytest -v {project}/tests

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: ./wheelhouse/*.whl

  macos_arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install RocksDB from Homebrew
        run: |
          brew fetch --force --bottle-tag=$BOTTLE_TAG rocksdb lz4 snappy zstd
          brew uninstall lz4 snappy zstd
          brew install $(brew --cache --bottle-tag=$BOTTLE_TAG rocksdb)
          brew install $(brew --cache --bottle-tag=$BOTTLE_TAG lz4)
          brew install $(brew --cache --bottle-tag=$BOTTLE_TAG snappy)
          brew install $(brew --cache --bottle-tag=$BOTTLE_TAG zstd)
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1

          BOTTLE_TAG: arm64_big_sur

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.12.1
        env:
          CIBW_BUILD_VERBOSITY: 1
          CIBW_BUILD: cp{38,39,310,311}-macosx_arm64
          CIBW_ARCHS: arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: wheels
          path: ./wheelhouse/*.whl

  # publish_wheels:
  #   name: Publish wheels
  #   if: github.event.inputs.make_release == 'true'
  #   needs: build_wheels
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v3
  #       with:
  #         submodules: recursive
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: wheels
  #         path: wheelhouse
  #     - name: Create release
  #       run: gh release create ${{ github.event.inputs.tag }} ./wheelhouse/*.whl --generate-notes
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
